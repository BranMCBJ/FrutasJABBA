@model FrutasJABBA.ViewsModels.FrutaViewModel
@{
    List<Fruta> frutas = Model.Frutas;
    List<StockFruta> stocksFrutas = Model.StocksFrutas;
}
<body>
    <div class="container-fluid px-sm-1 px-md-3 px-lg-3" style="border-bottom: 1px solid rgba(0,0,0,0.25);">
        <h3 style="color: black;">Resumen del inventario</h3>
        <div class="row" style="margin-top: 20px;">
            <div class="col-12 col-sm-12 col-md-6 col-lg-3">
                <div class="card mb-3">
                    <div class="row g-0 align-items-center">
                        <div class="col-sm-10 col-md-10 col-lg-9">
                            <div class="card-body">
                                <p class="card-text">Costo actual del inventario</p>
                                <h3 class="card-title">
                                    @{
                                        decimal costoActual = 0;
                                        foreach(var item in stocksFrutas)
                                        {
                                            costoActual += item.Precio;
                                        }
                                    }
                                    ₡ @costoActual.ToString("N2")
                                </h3>
                                <p class="card-text" style="color: white;"><small>a</small></p>
                            </div>
                        </div>
                        <div class="col-1 col-sm-2 col-md-2 col-lg-3">
                            <span style="color: white; background-color: #FF0040; border-radius: 100%; width: 50px; height: 50px;" class="d-flex justify-content-center align-items-center fs-2">₡</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-3">
                <div class="card mb-3">
                    <div class="row g-0 align-items-center">
                        <div class="col-sm-10 col-md-10 col-lg-9">
                            <div class="card-body">
                                <p class="card-text">Stock total</p>                                
                                @{
                                    var cantidad = 0;
                                    foreach(StockFruta item in stocksFrutas)
                                    {
                                        cantidad++;
                                    }
                                }
                                <h3 class="card-title">@cantidad</h3>
                                <br/>
                                <p class="card-text"><small class="text-success"><!--+5 nuevos--></small></p>
                            </div>
                        </div>
                        <div class="col-1 col-sm-2 col-md-2 col-lg-3">
                            <span style="color: white; background-color: #367338; border-radius: 100%; width: 50px; height: 50px;" class="d-flex justify-content-center align-items-center fs-2">
                                <i class="fa-solid fa-boxes" style="color: white;"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-3">
                <div class="card mb-3" style="background-color:gray;">
                    <!--<div class="row g-0 align-items-center">
                    <div class="col-sm-10 col-md-10 col-lg-9">
                    <div class="card-body">
                    <p class="card-text">Perdida promedio de fruta</p>
                    <h3 class="card-title">11%</h3>
                    <p class="card-text"><small class="text-danger">+2% vs la semana pasada</small></p>
                    </div>
                    </div>
                    <div class="col-1 col-sm-2 col-md-2 col-lg-3">
                    <span style="color: white; background-color: #FF1E00; border-radius: 100%; width: 50px; height: 50px;" class="d-flex justify-content-center align-items-center fs-2">
                    <i class="bi bi-graph-down-arrow" style="color: white;"></i>
                    </span>
                    </div>
                    </div>-->
                    <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                        <h6>Lo sentimos</h6>
                        <h6>Esta función no está disponible</h6>
                        <span style="width: 40px; height: 40px;" class="d-flex justify-content-center align-items-center fs-2">
                            <i class="bi bi-emoji-frown" style="color: rgba(0,0,0,0.60);"></i>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-3">
                <div class="card mb-3" style="background-color:gray;">
                    <!--<div class="row g-0 align-items-center">
                    <div class="col-sm-10 col-md-10 col-lg-9">
                    <div class="card-body">
                    <p class="card-text">Ganancia promedio</p>
                    <h3 class="card-title">20%</h3>
                    <p class="card-text"><small class="text-success">+12% vs la semana pasada</small></p>
                    </div>
                    </div>
                    <div class="col-1 col-sm-2 col-md-2 col-lg-3">
                    <span style="background-color: #7AA852; border-radius: 100%; width: 50px; height: 50px;" class="d-flex justify-content-center align-items-center fs-2">
                    <i class="bi bi-graph-up-arrow" style="color: white;"></i>
                    </span>
                    </div>
                    </div>-->
                    <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                        <h6>Lo sentimos</h6>
                        <h6>Esta función no está disponible</h6>
                        <span style="width: 40px; height: 40px;" class="d-flex justify-content-center align-items-center fs-2">
                            <i class="bi bi-emoji-frown" style="color: rgba(0,0,0,0.60);"></i>
                        </span>
                    </div>
                </div>
            </div>            
        </div>
    </div>
    <div class="container-fluid pt-4" style="border-bottom: 1px solid rgba(0,0,0,0.25);">
        <h3>Estado del inventario</h3>
        <div class="row g-3 mt-2">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card mb-3" style="background: rgba(255,32,0,0.25);">
                    <div class="card-body d-flex align-items-center px-3">
                        <div class="h5 ms-3 mt-2">Sin stock</div>
                    </div>
                    @{int c1 = Model.Frutas.Count(f => f.IDEstado == 2);}
                    <div class="h2 ms-3 ms-lg-5" style="margin-top:-20px;"><strong>@c1</strong></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card mb-3" style="background: rgba(255,77,0,0.25);">
                    <div class="card-body d-flex align-items-center px-3">
                        <div class="h5 ms-3 mt-2">Poco stock</div>
                    </div>
                    @{int c2 = Model.Frutas.Count(f => f.IDEstado == 3);}
                    <div class="h2 ms-3 ms-lg-5" style="margin-top:-20px;"><strong>@c2</strong></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card mb-3" style="background: rgba(122,168,82,0.25);">
                    <div class="card-body d-flex align-items-center px-3">
                        <div class="h5 ms-3 mt-2">Disponibles</div>
                    </div>
                    @{int c3 = Model.Frutas.Count(f => f.IDEstado == 4);}
                    <div class="h2 ms-3 ms-lg-5" style="margin-top:-20px;"><strong>@c3</strong></div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card mb-3" style="background: rgba(197,207,59,0.25);">
                    <div class="card-body d-flex align-items-center px-3">
                        <div class="h5 ms-3 mt-2">Sobrantes</div>
                    </div>
                    @{int c4 = Model.Frutas.Count(f => f.IDEstado == 5);}
                    <div class="h2 ms-3 ms-lg-5" style="margin-top:-20px;"><strong>@c4</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-3">
        <form>
            <div class="row">
                <div class="col-6 col-md-4 ">
                    <div class="input-group" style="border: 0.5px solid rgba(0,0,0,0.25); border-radius:5px;">
                        <span class="input-group-text bg-white border-0 px-3">
                            <i class="bi bi-search"></i>
                        </span>
                        <input id="searchInput" type="text" class="form-control fs-5 px-4" placeholder="Buscar fruta"
                        style="border-style: none;">
                    </div>
                </div>
                <div class="col">
                    <div class="input-group align-items-center">
                        <div class="h6 mt-1">Estado:</div>
                        <div class="dropdown ms-1" style="border: 0.5px solid rgba(0,0,0,0.25); border-radius:5px;">
                            <select id="estadoSelect" class="form-select w-auto" name="estados">
                                <option value="0" selected>Cualquiera</option>
                                <option value="2">Sin stock</option>
                                <option value="3">Poco stock</option>
                                <option value="4">Disponibles</option>
                                <option value="5">Sobrantes</option>
                            </select>
                        </div>
                        <button type="button" class="btn d-flex align-items-center ms-auto" 
                        style="background-color: #367338; color:white; border-start-start-radius:5px; border-end-start-radius:5px;" 
                        data-bs-toggle="modal" data-bs-target="#addFruta">
                            <i class="fas fa-plus"></i> <h6 class="ms-1 mt-2">Nueva fruta</h6>
                        </button>
                    </div>                    
                </div>
            </div>           
        </form>
        <div class="modal fade" id="addFruta" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Insertar fruta</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <form method="post" asp-controller="Fruta" asp-action="Create">
                        <div class="modal-body">
                            <h6>Inserte los datos de la fruta</h6>

                            <label class="form-label">Nombre:</label>
                            <input name="nuevaFruta.Nombre" class="form-control" type="text" required />

                            <label class="form-label">Emoji de identificación:</label>
                            <input name="nuevaFruta.Emoji" class="form-control" type="text" />

                            <div class="form-check mt-2">
                                <label class="form-check-label">Es variable</label>
                                <input name="nuevaFruta.Variable" type="checkbox" class="form-check-input" />
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">Agregar</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-2" style="border:1px solid rgba(0,0,0,0.25); border-radius: 10px;">
        <table id="tablaFrutas" class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Emoji</th>
                    <th>Precio/Gramo</th>
                    <th>Peso actual</th>
                    <th>Peso requerido</th>
                    <th>Estado</th>
                    <th>FDU</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var item in frutas)
                {
                    string clasePesoR = item.PesoActual > item.PesoRequerido ? "text-success" : "text-danger";
                    string claseEstado = "";
                    switch (item.IDEstado)
                    {   
                        case 2:
                            claseEstado = "color:rgb(255,32,0);";
                            break;
                        case 3:
                            claseEstado = "color:rgb(255,77);";
                            break;
                        case 4:
                            claseEstado = "color:rgb(122,168);";
                            break;
                        case 5:
                            claseEstado = "color:rgb(197,207);";
                            break;
                    }

                    <tr data-estado="@item.Estado.IDEstado">
                        <td>@item.IDFruta</td>
                        <td>@item.Nombre</td>
                        <td>@item.Emoji</td>
                        <td style="color:rgb(0,0,0,0.8)">₡ @item.PrecioG.ToString("0.##")</td>
                        <td>@item.PesoActual g</td>
                        <td class="@clasePesoR">@item.PesoRequerido g</td>
                        <td style="@claseEstado">@item.Estado.Estado</td>
                        <td style="color:rgb(0,0,0,0.8)">@item.FDU</td>
                        <td class="btn-group" role="group">
                            <a asp-controller="StockFruta" asp-action="Index" asp-route-IDFruta="@item.IDFruta" class="btn btn-success" target="_blank">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button type="button" class="btn" style="background-color: #8ECD89; color:white;" data-bs-toggle="modal" data-bs-target="#editFruta">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn" style="background-color: #367338; color:white;" data-bs-toggle="modal" data-bs-target="#addStock-@item.IDFruta">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button type="button" class="btn btn-danger" style="border-start-end-radius:5px; border-end-end-radius:5px;" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal-@item.IDFruta">
                                <i class="fas fa-trash-alt"></i>
                            </button>

                            <div class="modal fade" id="editFruta" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Insertar nuevos datos</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                        </div>
                                        <form method="post" asp-controller="Fruta" asp-action="Edit" asp-route-IDFruta="@item.IDFruta">
                                            <div class="modal-body">
                                                <h6>Inserte los datos de @item.Nombre</h6>

                                                <label class="form-label">Nombre:</label>
                                                <input name="nuevaFruta.Nombre" class="form-control" type="text" value="@item.Nombre" required />

                                                <label class="form-label">Emoji de identificación:</label>
                                                <input name="nuevaFruta.Emoji" class="form-control" type="text" value="@item.Emoji" />

                                                <div class="form-check mt-2">
                                                    <label class="form-check-label">Es variable</label>
                                                    <input name="nuevaFruta.Variable" type="checkbox" class="form-check-input" value="@item.Variable" />
                                                </div>
                                            </div>

                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-success">Agregar</button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade" id="confirmDeleteModal-@item.IDFruta" tabindex="-1" aria-labelledby="modalLabel-@item.IDFruta" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modalLabel-@item.IDFruta">Confirmar Eliminación</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                        </div>
                                        <div class="modal-body">
                                            ¿Estás seguro que deseas eliminar la fruta <strong>@item.Nombre</strong>?
                                        </div>
                                        <div class="modal-footer">
                                            <form method="post" asp-controller="Fruta" asp-action="Delete" asp-route-IDFruta="@item.IDFruta">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                <button type="submit" class="btn btn-danger">Eliminar</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade" id="addStock-@item.IDFruta" tabindex="-1" aria-labelledby="modalLabel-@item.IDFruta" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <h5 class="modal-title" id="modalLabel-@item.IDFruta">Insertar @item.Nombre</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                        </div>

                                        <form method="post" asp-controller="StockFruta" asp-action="Create" asp-route-IDFruta="@item.IDFruta">
                                            <div class="modal-body">
                                                <h6>Inserte los datos del nuevo registro de @item.Nombre</h6>

                                                <label for="precio-@item.IDFruta" class="form-label">Precio de compra:</label>
                                                <div class="input-group mb-2">
                                                    <span class="input-group-text">₡</span>
                                                    <input id="precio-@item.IDFruta" class="form-control" name="Precio" type="number" required />
                                                </div>

                                                <label for="pesoTotal-@item.IDFruta" class="form-label">Peso total:</label>
                                                <div class="input-group mb-2">
                                                    <input class="form-control" name="PesoTotal" type="number" id="pesoTotal-@item.IDFruta" step="0.01" required />
                                                    <span class="input-group-text">g</span>
                                                </div>

                                                <label for="pesoUtilizable-@item.IDFruta" class="form-label">Peso utilizable:</label>
                                                <div class="input-group mb-2">
                                                    <input class="form-control" name="PesoUtilizable" type="number" id="pesoUtilizable-@item.IDFruta" step="0.01" />
                                                    <span class="input-group-text">g</span>
                                                </div>

                                                <label for="fdu-@item.IDFruta" class="form-label">Factor de Utilización (FDU):</label>
                                                <input class="form-control mb-2" name="FDU" type="number" id="fdu-@item.IDFruta"
                                                       value="@item.FDU.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)" readonly />                                                
                                            </div>
                                            <div class="modal-footer">
                                                <button type="submit" class="btn btn-success">Agregar</button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <script>                                  
                                    var modal = document.getElementById('addStock-@item.IDFruta');
                                    modal.addEventListener('hidden.bs.modal', function () {
                                        const form = modal.querySelector('form');
                                        if (form) {
                                            form.reset();                                           
                                        }
                                    });
                                </script>
                            </div>
                        </td>
                        <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                const selectEstado = document.getElementById("estadoSelect");
                                const inputBuscar = document.getElementById("searchInput");
                                const filas = document.querySelectorAll("#tablaFrutas tbody tr");

                                function filtrar() {
                                    const estadoSeleccionado = selectEstado.value;
                                    const textoBusqueda = inputBuscar.value.toLowerCase();

                                    filas.forEach(fila => {
                                        const idEstado = fila.getAttribute("data-estado");
                                        const contenidoFila = fila.innerText.toLowerCase();

                                        const cumpleEstado = (estadoSeleccionado === "0") || (idEstado === estadoSeleccionado);
                                        const cumpleBusqueda = contenidoFila.includes(textoBusqueda);

                                        if (cumpleEstado && cumpleBusqueda) {
                                            fila.style.display = "";
                                        } else {
                                            fila.style.display = "none";
                                        }
                                    });
                                }

                                selectEstado.addEventListener("change", filtrar);
                                inputBuscar.addEventListener("input", filtrar);
                            });
                        </script>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <script>
        document.getElementById('searchInput').addEventListener('input', function () {
            const filtro = this.value.toLowerCase();
            const filas = document.querySelectorAll('#tablaFrutas tbody tr');

            filas.forEach(fila => {
                const textoFila = fila.textContent.toLowerCase();

                if (textoFila.includes(filtro)) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        });
    </script>    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>